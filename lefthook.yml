# https://github.com/evilmartians/lefthook
# https://github.com/evilmartians/lefthook/blob/master/docs/mdbook/configuration/glob.md

pre-commit:
  parallel: true
  commands:
    fmt:
      glob: "*.go"
      run: |
        files=$(gofmt -l {staged_files})
        if [ -n "$files" ]; then
          echo "Files need formatting:"
          echo "$files"
          exit 1
        fi
      fail_text: "Run: gofmt -l -w ."
    vet:
      glob: "*.go"
      run: go vet ./...
    test:
      glob: "*.go"
      run: go test ./...
    tidy:
      glob: "*.go"
      run: |
        cp go.mod go.mod.bak
        cp go.sum go.sum.bak
        go mod tidy
        if ! diff -q go.mod go.mod.bak > /dev/null || ! diff -q go.sum go.sum.bak > /dev/null; then
          rm go.mod.bak go.sum.bak
          exit 1
        fi
        rm go.mod.bak go.sum.bak
      fail_text: "Run: go mod tidy"
    goreleaser:
      glob: ".goreleaser.yaml"
      run: goreleaser check
    build:
      glob: "*.go"
      run: go build -o /dev/null .
    shellcheck:
      glob: "*.sh"
      run: shellcheck --severity=warning {staged_files}
      fail_text: "Run: shellcheck {staged_files}"
    newline:
      stage_fixed: true
      run: |
        for file in {staged_files}; do
          if [ -s "$file" ] && [ -n "$(tail -c 1 "$file")" ]; then
            echo "" >> "$file"
          fi
        done
